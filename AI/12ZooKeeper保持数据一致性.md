在分布式文件系统HDFS、分布式NoSQL数据库等都用到了ZooKeeper。ZooKeeper让多台服务器状态保持一致。

服务器集群的脑裂问题。比如在HDFS中有两台NameNode服务器，如果不同DataNode上的应用程序对这两台服务器是否可用的判断不一致，应用程序觉得这两台服务器都可用，比如要完成对一个文件的写操作，这样会导致同时有两个应用程序对文件进行写操作，文件数据冲突，造成了服务器集群混乱，这就是脑裂。

分布式集群一致性的要求大致是：假设有一个分布式的提供所服务的集群，当应用程序访问该集群内任意一台服务器都可以获取或释放锁，而且同一台服务器的状态只能交给一个应用程序，这就需要集群内各服务器状态保持一致。

Paxos算法解决一致性：

- 应用程序连接到集群内任意一台服务器后A，提起状态修改请求
- 服务器A把请求发给集群内其它服务器进行表决
- 如果集群内服务器B也收到另一个应用程序同样的修改请求
- 服务器B可能会拒绝服务器A的表决
- 服务器B自己发起一个同样的表决请求
- 集群内其它服务器根据时间戳和服务器排序规则表决
- 表决结果发送给集群内所有服务器
- 一开始发起表决请求的服务器A根据表决结果决定修改请求是否需要执行

ZooKeeper使用ZAB(ZooKeeper Atomic Broadcast原子消息广播协议)

- 保证数据更新的一致性
- 高可用
- 所有服务器存储相同数据
- 树状结构存储数据
- 监听，当数据发生改变通知应用程序

ZooKeeper架构：

- 主服务器， active master,运行期间只能有一个服务器服务，管理集群的状态和元信息
- 从服务器，standby master作为热备，它的存在是为了保证高可用
- ZooKeeper: 主服务器和从服务器都有可能向其注册，Zookeeper发现某台服务器的心跳不正常，就会让其它热备master向其注册成为active master

ZooKeeper的缺点：多台服务器存储相同的数据，每次更新都需要所有服务器投票表决，所以随着服务器数量的增加性能会下降。

**Paxos算法放在区块链中思考**

Paxos算法假设集群中的节点是可信任的，如果集群中有恶意节点伪造数据、篡改数据呢？

比特币区块链是这样做的：区块链中的节点需要记录数据，或者说记账，为了保证节点的恶意作为，区块链通过工作量证明，计算一个256bit的hash值，这个值的前几位是0，为了进行hash计算，比特币区块链消耗的电量相当于中等规模国家的电量，恶意节点想要伪造篡改数据必须拥有强大的计算能力，相当于整个服务器计算能力的51%以上才可以。

